name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v2.3.0
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-release:
    name: Build Plugin Packages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Extract version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=dev-build" >> $GITHUB_OUTPUT
          fi
          echo "Building version: $VERSION"

      - name: Verify plugin.info version matches tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          PLUGIN_VERSION=$(python3 -c "import json; print(json.load(open('plugins/collaborative-blog/plugin.info'))['version'])")
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          echo "Plugin version: $PLUGIN_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$PLUGIN_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: plugin.info version ($PLUGIN_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi
          echo "✓ Version verification passed"

      - name: Build core plugin package (.tid)
        run: |
          echo "Building core plugin package..."
          python3 create-plugin-tid.py
          ls -lh collaborative-blog-plugin.tid

      - name: Build complete plugin package (.json)
        run: |
          echo "Building complete plugin package with examples..."
          python3 convert-to-json.py
          ls -lh collaborative-blog-plugin.json

      - name: Verify packages contain JavaScript modules
        run: |
          echo "Verifying collaborative-blog-plugin.json contains JavaScript modules..."
          JS_COUNT=$(python3 -c "import json; data = json.load(open('collaborative-blog-plugin.json')); js_tiddlers = [t for t in data['tiddlers'] if '.js' in t]; print(len(js_tiddlers))")
          echo "JavaScript modules found: $JS_COUNT"
          if [ "$JS_COUNT" -lt 4 ]; then
            echo "Error: Expected at least 4 JavaScript modules, found $JS_COUNT"
            exit 1
          fi
          echo "✓ Package verification passed"

      - name: Generate checksums
        run: |
          sha256sum collaborative-blog-plugin.tid > checksums.txt
          sha256sum collaborative-blog-plugin.json >> checksums.txt
          cat checksums.txt

      - name: Create release notes from RELEASE_NOTES
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          RELEASE_FILE="RELEASE_NOTES_v${VERSION}.md"

          if [ -f "$RELEASE_FILE" ]; then
            echo "Using release notes from $RELEASE_FILE"
            echo "notes_file=$RELEASE_FILE" >> $GITHUB_OUTPUT
          else
            echo "Release notes file not found: $RELEASE_FILE"
            echo "Creating default release notes..."
            cat > temp_release_notes.md << 'EOF'
          # Release ${{ steps.get_version.outputs.tag_name }}

          ## Installation

          Download one of the plugin packages below and import it into your TiddlyWiki:

          - **collaborative-blog-plugin.json** - Complete package with example content (recommended for new users)
          - **collaborative-blog-plugin.tid** - Core plugin only, no examples (recommended for existing wikis)

          ## Changes

          See [CHANGELOG.md](https://github.com/BenSweaterVest/TiddlySite/blob/main/CHANGELOG.md) for detailed changes.

          ## Documentation

          Full documentation available in [README.md](https://github.com/BenSweaterVest/TiddlySite/blob/main/README.md)
          EOF
            echo "notes_file=temp_release_notes.md" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          name: Release ${{ steps.get_version.outputs.tag_name }}
          body_path: ${{ steps.release_notes.outputs.notes_file }}
          draft: false
          prerelease: false
          files: |
            collaborative-blog-plugin.tid
            collaborative-blog-plugin.json
            checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts (for manual builds)
        if: "!startsWith(github.ref, 'refs/tags/v')"
        uses: actions/upload-artifact@v3
        with:
          name: plugin-packages-${{ steps.get_version.outputs.version }}
          path: |
            collaborative-blog-plugin.tid
            collaborative-blog-plugin.json
            checksums.txt
          retention-days: 30
